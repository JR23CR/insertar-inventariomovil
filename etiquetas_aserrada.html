<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Etiquetas - Madera Aserrada</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsbarcode/3.11.5/JsBarcode.all.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #16a085;
            --bg: #f4f7f6;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 15px;
            color: var(--primary);
        }
        .container { max-width: 100%; }
        h2 { text-align: center; font-size: 1.2rem; margin-bottom: 20px; }
        
        .card {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        input {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1.1rem;
            text-align: center;
        }

        button {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
        }
        .btn-search { background-color: var(--accent); color: white; }
        .btn-print { background-color: #2c3e50; color: white; margin-top: 20px; }
        .btn-back { background-color: #7f8c8d; color: white; text-decoration: none; display: block; text-align: center; margin-top: 20px; padding: 12px; border-radius: 8px; }

        #status { font-size: 0.9rem; color: #666; margin-bottom: 10px; text-align: center; }

        /* ESTILOS DE LA ETIQUETA (Visualizaci√≥n en pantalla) */
        #label-preview-container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        
        .label-box {
            width: 4in;
            height: 3in;
            background: white;
            border: 2px dashed #333;
            padding: 10px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        /* ESTILOS DE IMPRESI√ìN (4x3 Pulgadas) */
        @media print {
            @page { size: 4in 3in; margin: 0; }
            body * { visibility: hidden; }
            #label-preview-container, #label-preview-container * { visibility: visible; }
            #label-preview-container {
                position: fixed;
                left: 0; top: 0;
                width: 100%; height: 100%;
                margin: 0; padding: 0;
                display: block;
            }
            .label-box {
                border: none; /* Quitar borde punteado al imprimir */
                width: 4in;
                height: 3in;
                margin: 0;
                page-break-after: always;
            }
            .no-print { display: none; }
        }

        /* Contenido de la etiqueta */
        .lbl-header { font-size: 1.2rem; font-weight: bold; margin-bottom: 5px; }
        .lbl-sub { font-size: 0.9rem; margin-bottom: 5px; }
        .lbl-detail { font-size: 1rem; font-weight: bold; margin: 2px 0; }
        .lbl-grid { display: flex; justify-content: space-around; width: 100%; margin-top: 5px; border-top: 2px solid black; padding-top: 5px; }
        .lbl-col { display: flex; flex-direction: column; }
        .lbl-val { font-size: 1.4rem; font-weight: bold; }
        .lbl-tit { font-size: 0.8rem; text-transform: uppercase; }
        
    </style>
</head>
<body>
    <div class="container">
        <h2 class="no-print">üè∑Ô∏è Imprimir Etiquetas (Aserrada)</h2>
        
        <div class="card no-print">
            <div id="status">Conectando...</div>
            <label style="font-weight:bold;">N√∫mero de Bulto</label>
            <input type="text" id="searchBulto" placeholder="Ej: 501">
            <button class="btn-search" onclick="buscarBulto()">BUSCAR ETIQUETA</button>
        </div>

        <div id="label-preview-container" style="display:none;">
            <div class="label-box" id="etiqueta">
                <div class="lbl-header">MADERA ASERRADA</div>
                <svg id="barcode"></svg>
                <div class="lbl-sub" id="lbl-idcode">CODE</div>
                
                <div style="width:100%; border-bottom: 2px solid black; margin: 5px 0;"></div>
                
                <div class="lbl-detail" id="lbl-especie">ESPECIE</div>
                <div class="lbl-detail" id="lbl-calidad">CALIDAD</div>
                <div class="lbl-detail" id="lbl-dims">GROSOR - CONDICION</div>
                
                <div class="lbl-grid">
                    <div class="lbl-col">
                        <span class="lbl-val" id="lbl-pt">0.00</span>
                        <span class="lbl-tit">Pies Tablares</span>
                    </div>
                    <div class="lbl-col">
                        <span class="lbl-val" id="lbl-pzs">0</span>
                        <span class="lbl-tit">Piezas</span>
                    </div>
                </div>
                <div style="margin-top:auto; font-size:0.8rem;" id="lbl-fecha">Fecha</div>
            </div>
        </div>

        <button id="btnPrint" class="btn-print no-print" style="display:none;" onclick="window.print()">üñ®Ô∏è IMPRIMIR</button>

        <a href="menu_aserrada.html" class="btn-back no-print">‚¨Ö Volver al Men√∫</a>
    </div>

    <script>
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyJm67IZXi_zHsxQv3mqosqb6-RyKp4-j-h-kqdP153HTN8t6lt7BPE5BrwSzphArkx/exec";
        let inventario = [];

        window.onload = function() {
            cargarInventario();
            document.getElementById('searchBulto').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') buscarBulto();
            });
        };

        function cargarInventario() {
            const status = document.getElementById('status');
            fetch(GOOGLE_SCRIPT_URL + "?sheet=MADERA ASERRADA")
            .then(res => res.json())
            .then(data => {
                inventario = data;
                status.innerText = `‚úÖ Listo: ${data.length} registros cargados.`;
                status.style.color = "#16a085";
            })
            .catch(err => {
                status.innerText = "‚ùå Error cargando datos.";
            });
        }

        function buscarBulto() {
            const bulto = document.getElementById('searchBulto').value.trim();
            if (!bulto) return;

            // Filtrar filas del bulto
            const filas = inventario.filter(row => String(row['FARDO']) === String(bulto));

            if (filas.length === 0) {
                alert("‚ùå Bulto no encontrado");
                document.getElementById('label-preview-container').style.display = 'none';
                document.getElementById('btnPrint').style.display = 'none';
                return;
            }

            const head = filas[0];
            let totalPiezas = 0;
            let totalPT = 0;

            filas.forEach(f => {
                totalPiezas += parseInt(f['PIEZAS']) || 0;
                totalPT += parseFloat(f['PIES TABLARES']) || 0;
            });

            // Llenar datos
            document.getElementById('lbl-idcode').innerText = head['ID CODE'] || `${head['POA']}-${head['FARDO']}`;
            document.getElementById('lbl-especie').innerText = head['ESPECIE'];
            document.getElementById('lbl-calidad').innerText = head['CALIDAD'];
            document.getElementById('lbl-dims').innerText = `${head['GROSOR']} - ${head['CONDICION']} - ${head['UBICACION']}`;
            document.getElementById('lbl-pt').innerText = totalPT.toFixed(2);
            document.getElementById('lbl-pzs').innerText = totalPiezas;
            
            let fecha = head['Fecha de ingreso'];
            if(fecha && fecha.includes('T')) fecha = new Date(fecha).toLocaleDateString();
            document.getElementById('lbl-fecha').innerText = `Bulto: ${head['FARDO']} | Fecha: ${fecha}`;

            // Generar C√≥digo de Barras
            JsBarcode("#barcode", head['ID CODE'] || `${head['POA']}-${head['FARDO']}`, {
                format: "CODE128",
                height: 50,
                width: 2,
                displayValue: false,
                margin: 5
            });

            document.getElementById('label-preview-container').style.display = 'flex';
            document.getElementById('btnPrint').style.display = 'block';
        }
    </script>
</body>
</html>
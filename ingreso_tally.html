<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ingreso de Tallys - Madera Aserrada</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #8e44ad; /* Morado de Aserrada */
            --bg: #f4f7f6;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 15px;
            color: var(--primary);
        }
        .container { max-width: 100%; }
        h2 { text-align: center; font-size: 1.2rem; }
        
        .card {
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        label { display: block; margin-top: 10px; font-weight: bold; font-size: 0.9rem; }
        input, select {
            width: 100%;
            padding: 12px;
            margin-top: 5px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1rem;
        }

        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        button {
            width: 100%;
            padding: 12px;
            margin-top: 15px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
        }
        .btn-main { background-color: var(--accent); color: white; }
        .btn-secondary { background-color: var(--primary); color: white; }
        .btn-back { background-color: #7f8c8d; color: white; text-decoration: none; display: block; text-align: center; }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            white-space: nowrap;
        }
        th, td {
            padding: 8px;
            text-align: center;
            border: 1px solid #ddd;
        }
        thead th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
            z-index: 2;
        }
        tbody th { /* Para la columna de Ancho */
            position: sticky;
            left: 0;
            background-color: #f2f2f2;
            z-index: 1;
        }
        tfoot td {
            font-weight: bold;
            background-color: #e8f6f3;
        }
        td input {
            width: 60px;
            padding: 5px;
            margin: 0;
            text-align: center;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        .total-col {
            font-weight: bold;
            background-color: #eafaf1;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>üìù Ingreso de Tallys</h2>

    <div class="card">
        <h3>Encabezado del Bulto</h3>
        <div class="grid-3">
            <div>
                <label>Fecha</label>
                <input type="date" id="fecha">
            </div>
            <div>
                <label>POA</label>
                <input type="text" id="poa" placeholder="Ej: 123-ABC">
            </div>
            <div>
                <label>No. Bulto</label>
                <input type="number" id="bultoNo" placeholder="Ej: 501">
            </div>
        </div>
        <div class="grid-3">
            <div>
                <label>Especie</label>
                <input type="text" id="especie" value="Teca">
            </div>
            <div>
                <label>Calidad</label>
                <input type="text" id="calidad" value="A">
            </div>
            <div>
                <label>Espesor</label>
                <select id="espesor">
                    <option value="1">4/4"</option>
                    <option value="1.25">5/4"</option>
                    <option value="1.5">6/4"</option>
                    <option value="2">8/4"</option>
                </select>
            </div>
        </div>
        <div class="grid-3">
            <div>
                <label>Condici√≥n</label>
                <select id="condicion">
                    <option value="Verde">Verde</option>
                    <option value="Seco Aire">Seco Aire (AD)</option>
                    <option value="Seco Horno">Seco Horno (KD)</option>
                </select>
            </div>
            <div>
                <label>Ubicaci√≥n</label>
                <input type="text" id="ubicacion" placeholder="Ej: Patio 1">
            </div>
            <div>
                <label>Tipo de Producto</label>
                <input type="text" id="tipoProducto" value="Madera Aserrada">
            </div>
        </div>
        <div class="grid-3">
            <div>
                <label>CA</label>
                <input type="text" id="ca" placeholder="Control Abastecimiento">
            </div>
            <div>
                <label>ID Code</label>
                <input type="text" id="idCode" placeholder="ID Opcional">
            </div>
            <div>
                <label>Fecha Secado</label>
                <input type="date" id="fechaSecado">
            </div>
        </div>
        <hr>
        <div class="grid-3">
            <div>
                <label>Largo M√≠nimo (')</label>
                <input type="number" id="largoMin" placeholder="Ej: 3">
            </div>
            <div>
                <label>Largo M√°ximo (')</label>
                <input type="number" id="largoMax" placeholder="Ej: 7">
            </div>
            <div>
                <label>&nbsp;</label>
                <button class="btn-main" onclick="generarTabla()" style="margin-top: 5px; padding: 12px;">Generar Tabla</button>
            </div>
        </div>
    </div>

    <div class="card">
        <h3>Detalle de Piezas</h3>
        <div class="table-container">
            <table id="tallyTable">
                <thead>
                    <!-- Se genera con JS -->
                </thead>
                <tbody>
                    <!-- Se genera con JS -->
                </tbody>
                <tfoot>
                    <!-- Se genera con JS -->
                </tfoot>
            </table>
        </div>
        <button class="btn-secondary" onclick="exportarCSV()">Exportar a CSV</button>
        <button class="btn-main" onclick="guardarTally()" style="margin-top: 10px;">üíæ Guardar en Nube</button>
    </div>

    <a href="menu_aserrada.html" class="btn-back">‚¨Ö Volver al Men√∫</a>
</div>

<script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyJm67IZXi_zHsxQv3mqosqb6-RyKp4-j-h-kqdP153HTN8t6lt7BPE5BrwSzphArkx/exec";

    window.onload = function() {
        // Poner fecha actual por defecto
        document.getElementById('fecha').valueAsDate = new Date();
    };

    function generarTabla() {
        const largoMin = parseInt(document.getElementById('largoMin').value);
        const largoMax = parseInt(document.getElementById('largoMax').value);

        if (isNaN(largoMin) || isNaN(largoMax) || largoMin > largoMax) {
            alert("Por favor, define un rango de largos v√°lido.");
            return;
        }

        const table = document.getElementById('tallyTable');
        table.innerHTML = ''; // Limpiar tabla anterior

        // 1. Crear Encabezado (thead)
        const thead = table.createTHead();
        const headerRow = thead.insertRow();
        let th = document.createElement('th');
        th.innerHTML = "Ancho (in)";
        headerRow.appendChild(th);

        for (let largo = largoMin; largo <= largoMax; largo++) {
            th = document.createElement('th');
            th.innerHTML = `${largo}' Pzs`;
            headerRow.appendChild(th);
        }
        th = document.createElement('th');
        th.innerHTML = "Total Pzs";
        th.className = "total-col";
        headerRow.appendChild(th);

        th = document.createElement('th');
        th.innerHTML = "Total PT";
        th.className = "total-col";
        headerRow.appendChild(th);

        // 2. Crear Cuerpo (tbody) con anchos de 1 a 23
        const tbody = table.createTBody();
        for (let ancho = 1; ancho <= 23; ancho++) {
            const row = tbody.insertRow();
            let cell = row.insertCell();
            cell.outerHTML = `<th>${ancho}"</th>`; // Usar <th> para sticky

            for (let largo = largoMin; largo <= largoMax; largo++) {
                cell = row.insertCell();
                cell.innerHTML = `<input type="number" min="0" oninput="calcularTotales()" data-ancho="${ancho}" data-largo="${largo}">`;
            }
            // Celda para Total Piezas por fila
            row.insertCell().className = 'total-col';
            // Celda para Total PT por fila
            row.insertCell().className = 'total-col';
        }

        // 3. Crear Pie de Tabla (tfoot)
        const tfoot = table.createTFoot();
        const footerRow = tfoot.insertRow();
        footerRow.insertCell().innerHTML = "TOTALES";

        for (let largo = largoMin; largo <= largoMax; largo++) {
            footerRow.insertCell(); // Celdas para totales por largo
        }
        footerRow.insertCell().id = 'granTotalPiezas'; // Celda para Gran Total Piezas
        footerRow.insertCell().id = 'granTotalPT'; // Celda para Gran Total PT
        
        calcularTotales(); // Calcular una vez para inicializar en 0
    }

    function calcularTotales() {
        const espesor = parseFloat(document.getElementById('espesor').value);
        if (isNaN(espesor)) return;

        const tbody = document.getElementById('tallyTable').tBodies[0];
        const tfoot = document.getElementById('tallyTable').tFoot;
        const numCols = document.getElementById('tallyTable').tHead.rows[0].cells.length;
        const numLargoCols = numCols - 3; // Ancho, TotalPzs, TotalPT

        let granTotalPiezas = 0;
        let granTotalPT = 0;
        const totalesPorLargo = new Array(numLargoCols).fill(0);

        for (const row of tbody.rows) {
            let totalPiezasFila = 0;
            let totalPTFila = 0;
            const ancho = parseInt(row.cells[0].innerText);

            // Iterar solo por las columnas de input de largo
            for (let i = 0; i < numLargoCols; i++) {
                const input = row.cells[i + 1].getElementsByTagName('input')[0];
                const piezas = parseInt(input.value) || 0;
                
                if (piezas < 0) { // Validaci√≥n
                    alert("No se permiten n√∫meros negativos.");
                    input.value = 0;
                    continue;
                }
                
                const largo = parseFloat(input.dataset.largo);
                
                totalPiezasFila += piezas;
                totalesPorLargo[i] += piezas;

                // F√≥rmula: (Espesor * Ancho * Largo / 12) * Piezas
                const pt = (espesor * ancho * largo / 12) * piezas;
                totalPTFila += pt;
            }

            row.cells[numCols - 2].innerText = totalPiezasFila; // Total Pzs Fila
            row.cells[numCols - 1].innerText = totalPTFila.toFixed(2); // Total PT Fila

            granTotalPiezas += totalPiezasFila;
            granTotalPT += totalPTFila;
        }

        // Actualizar pie de tabla (tfoot)
        const footerRow = tfoot.rows[0];
        for (let i = 0; i < numLargoCols; i++) {
            footerRow.cells[i + 1].innerText = totalesPorLargo[i];
        }
        document.getElementById('granTotalPiezas').innerText = granTotalPiezas;
        document.getElementById('granTotalPT').innerText = granTotalPT.toFixed(2);
    }

    function exportarCSV() {
        const table = document.getElementById('tallyTable');
        if (!table.tHead.rows.length) {
            alert("Primero genera la tabla y a√±ade datos.");
            return;
        }

        let csv = [];
        
        // Encabezados exactos de la Hoja de Google Sheet
        const headers = [
            "No.", "FARDO", "GROSOR", "LARGO", "ANCHO", "PIES TABLARES", "PIEZAS", 
            "POA", "CONDICION", "Fecha de ingreso", "UBICACION", "CA", 
            "CALIDAD", "ESPECIE", "TIPO DE PRODUCTO", "ID CODE", "Fecha de Secado"
        ];
        csv.push(headers.join(','));

        // Valores del formulario (Encabezado)
        const fardo = document.getElementById('bultoNo').value;
        const grosor = document.getElementById('espesor').options[document.getElementById('espesor').selectedIndex].text;
        const poa = document.getElementById('poa').value;
        const condicion = document.getElementById('condicion').value;
        const fecha = document.getElementById('fecha').value;
        const ubicacion = document.getElementById('ubicacion').value;
        const ca = document.getElementById('ca').value;
        const calidad = document.getElementById('calidad').value;
        const especie = document.getElementById('especie').value;
        const tipoProd = document.getElementById('tipoProducto').value;
        const idCode = document.getElementById('idCode').value;
        const fechaSecado = document.getElementById('fechaSecado').value;

        // Filas de la tabla
        let rowCounter = 1;
        for (const row of table.tBodies[0].rows) {
            const ancho = row.cells[0].innerText.replace('"', '');
            const numCols = row.cells.length;
            
            // Iterar sobre las columnas de largo (saltando Ancho y Totales)
            for (let i = 1; i < numCols - 2; i++) {
                const input = row.cells[i].getElementsByTagName('input')[0];
                const piezas = parseInt(input.value) || 0;
                
                if (piezas > 0) {
                    const largo = input.dataset.largo;
                    // Calcular PT individual para esta l√≠nea
                    const espesorVal = parseFloat(document.getElementById('espesor').value);
                    const pt = (espesorVal * parseFloat(ancho) * parseFloat(largo) / 12) * piezas;

                    // Construir fila CSV en el orden solicitado
                    const rowData = [
                        rowCounter++, // No.
                        fardo,        // FARDO
                        grosor,       // GROSOR
                        largo,        // LARGO
                        ancho,        // ANCHO
                        pt.toFixed(2),// PIES TABLARES
                        piezas,       // PIEZAS
                        poa,          // POA
                        condicion,    // CONDICION
                        fecha,        // Fecha de ingreso
                        ubicacion,    // UBICACION
                        ca,           // CA
                        calidad,      // CALIDAD
                        especie,      // ESPECIE
                        tipoProd,     // TIPO DE PRODUCTO
                        idCode,       // ID CODE
                        fechaSecado   // Fecha de Secado
                    ];
                    csv.push(rowData.join(','));
                }
            }
        }

        // Crear y descargar el archivo
        const csvContent = "data:text/csv;charset=utf-8," + csv.join("\n");
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        const bultoNo = document.getElementById('bultoNo').value || 'TALLY';
        link.setAttribute("download", `Tally_${bultoNo}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function guardarTally() {
        const bulto = document.getElementById('bultoNo').value;
        if (!bulto) {
            alert("Por favor, ingresa el N√∫mero de Bulto.");
            return;
        }

        const table = document.getElementById('tallyTable');
        if (!table.tHead || table.tHead.rows.length === 0) {
            alert("Primero genera la tabla e ingresa datos.");
            return;
        }

        // Recopilar Encabezado
        const encabezado = {
            fecha: document.getElementById('fecha').value,
            poa: document.getElementById('poa').value,
            bulto: bulto,
            especie: document.getElementById('especie').value,
            calidad: document.getElementById('calidad').value,
            espesor: document.getElementById('espesor').options[document.getElementById('espesor').selectedIndex].text,
            espesorVal: parseFloat(document.getElementById('espesor').value),
            // Nuevos campos para coincidir con Sheet
            condicion: document.getElementById('condicion').value,
            ubicacion: document.getElementById('ubicacion').value,
            ca: document.getElementById('ca').value,
            tipoProducto: document.getElementById('tipoProducto').value,
            idCode: document.getElementById('idCode').value,
            fechaSecado: document.getElementById('fechaSecado').value
        };

        // Recopilar Detalles (Solo celdas con valores > 0)
        const detalles = [];
        const tbody = table.tBodies[0];
        const numCols = table.tHead.rows[0].cells.length;
        const numLargoCols = numCols - 3; // Excluir Ancho, TotalPzs, TotalPT

        for (const row of tbody.rows) {
            const ancho = parseInt(row.cells[0].innerText);
            for (let i = 0; i < numLargoCols; i++) {
                const input = row.cells[i + 1].getElementsByTagName('input')[0];
                const piezas = parseInt(input.value) || 0;
                
                if (piezas > 0) {
                    const largo = parseFloat(input.dataset.largo);
                    const pt = (encabezado.espesorVal * ancho * largo / 12) * piezas;
                    detalles.push({ ancho, largo, piezas, pt: parseFloat(pt.toFixed(2)) });
                }
            }
        }

        if (detalles.length === 0) {
            alert("La tabla est√° vac√≠a (0 piezas).");
            return;
        }

        const payload = { tipo: "tally_aserrada", sheetName: "MADERA ASERRADA", ...encabezado, detalles };

        fetch(GOOGLE_SCRIPT_URL, { method: "POST", body: JSON.stringify(payload) })
            .then(res => alert("‚úÖ Tally guardado correctamente en Google Sheets."))
            .catch(err => alert("‚ùå Error al guardar: " + err));
    }
</script>

</body>
</html>